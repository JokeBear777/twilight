<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>책 추천</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo&family=Noto+Serif+KR&display=swap"
          rel="stylesheet">

    <style>
        .gradient-custom {
            background: linear-gradient(to right, rgba(106, 17, 203, 1), rgba(37, 117, 252, 1))
        }

        .btn.active {
            background-color: #ffc107 !important;
            color: black !important;
            border-color: #ffc107 !important;
        }

        /* 기본적으로 숨겨진 스크롤바 */
        .card-body::-webkit-scrollbar {
            width: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* 스크롤바 트랙 */
        .card-body::-webkit-scrollbar-track {
            background: transparent;
        }

        /* 스크롤바 손잡이 */
        .card-body::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        /* 스크롤 중일 때만 스크롤바 보이게 */
        .card-body.scrolling::-webkit-scrollbar {
            opacity: 1;
        }


        .bg-ivory {
            background-color: #fffff0;
        }


        h1,
        h2,
        h3,
        h4 {
            font-family: 'Nanum Myeongjo', serif;
        }

        body {
            font-family: 'Dongle', sans-serif;
        }
    </style>
</head>

<body class="gradient-custom">
<section class="d-flex justify-content-center align-items-center" style="min-height:100vh;">
    <!-- ① 카드 전체 -->
    <div class="card bg-dark d-flex flex-column"
         style="border-radius:1rem; width:375px; height:650px;">

        <!-- ② 스크롤되는 내용 영역 -------------->
        <div class="card-body p-3" style="overflow-y:auto;">
            <form th:action="@{/book/recommendation}" method="POST">
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

                <!-- Step 1 ------------------------------------------------>
                <div class="form-step" id="step1" style="display:block;">
                    <h5 class="text-white" th:text="${questionAnswerList[0].question}">질문 텍스트1</h5>

                    <div id="step1-answer-buttons"
                         class="d-flex flex-wrap justify-content-center mt-4">
                        <button type="button"
                                class="btn btn-outline-light m-1"
                                th:each="ans, idxStat : ${questionAnswerList[0].answers}"
                                th:text="${ans.answer}"
                                th:attr="data-id=${ans.answerId}"
                                onclick="toggleSelection(this, 0)">
                        </button>
                    </div>

                    <!-- hidden inputs -->
                    <input type="hidden" name="questions[0]"   th:value="${questionAnswerList[0].question}">
                    <input type="hidden" name="answerIds[0]"   id="selectAnswerId0">
                    <input type="hidden" name="answerTexts[0]" id="selectAnswerText0">

                    <div class="mt-4 text-center">
                        <button type="button"
                                class="btn btn-light mt-3"
                                onclick="nextStep()"> &gt; 다음 </button>
                    </div>
                </div>

                <!-- Step 2 ------------------------------------------------>
                <div class="form-step" id="step2" style="display:none;">
                    <h5 class="text-white" th:text="${questionAnswerList[1].question}">질문 텍스트2</h5>

                    <div id="step2-answer-buttons"
                         class="d-flex flex-wrap justify-content-center mt-4">
                        <button type="button"
                                class="btn btn-outline-light m-1"
                                th:each="ans, idxStat : ${questionAnswerList[1].answers}"
                                th:text="${ans.answer}"
                                th:attr="data-id=${ans.answerId}"
                                onclick="toggleSelection(this, 1)">
                        </button>
                    </div>

                    <!-- hidden inputs -->
                    <input type="hidden" name="questions[1]"   th:value="${questionAnswerList[1].question}">
                    <input type="hidden" name="answerIds[1]"   id="selectAnswerId1">
                    <input type="hidden" name="answerTexts[1]" id="selectAnswerText1">

                    <div class="mt-4 text-center">
                        <button type="button" class="btn btn-light mt-3 me-2" onclick="prevStep()"> &lt; 이전
                        </button>
                        <button type="button" class="btn btn-light mt-3" onclick="nextStep()"> > 다음 </button>
                    </div>
                </div>

                    <!-- Step 3 -->
                    <div class="form-step" id="step3" style="display: none;">
                        <h5 th:text="${questionAnswerList[2].question}" class="text-white">질문 텍스트3</h5>

                        <div id="step3-answer-buttons"
                             class="d-flex flex-wrap justify-content-center mt-4">
                            <button type="button"
                                    class="btn btn-outline-light m-1"
                                    th:each="ans, idxStat : ${questionAnswerList[2].answers}"
                                    th:text="${ans.answer}"
                                    th:attr="data-id=${ans.answerId}"
                                    onclick="toggleSelection(this, 2)">
                            </button>
                        </div>

                        <!-- hidden inputs -->
                        <input type="hidden" name="questions[2]"   th:value="${questionAnswerList[2].question}">
                        <input type="hidden" name="answerIds[2]"   id="selectAnswerId2">
                        <input type="hidden" name="answerTexts[2]" id="selectAnswerText2">

                        <div class="mt-4 text-center">
                            <button type="button" class="btn btn-light mt-3 me-2" onclick="prevStep()"> &lt; 이전
                            </button>
                            <button type="button" class="btn btn-light mt-3" onclick="nextStep()"> > 다음 </button>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="form-step" id="step4" style="display: none;">
                        <h5 th:text="${questionAnswerList[3].question}" class="text-white">질문 텍스트4</h5>

                        <div id="step4-answer-buttons"
                             class="d-flex flex-wrap justify-content-center mt-4">
                            <button type="button"
                                    class="btn btn-outline-light m-1"
                                    th:each="ans, idxStat : ${questionAnswerList[3].answers}"
                                    th:text="${ans.answer}"
                                    th:attr="data-id=${ans.answerId}"
                                    onclick="toggleSelection(this, 3)">
                            </button>
                        </div>

                        <!-- hidden inputs -->
                        <input type="hidden" name="questions[3]"   th:value="${questionAnswerList[3].question}">
                        <input type="hidden" name="answerIds[3]"   id="selectAnswerId3">
                        <input type="hidden" name="answerTexts[3]" id="selectAnswerText3">

                        <div class="mt-4 text-center">
                            <button type="button" class="btn btn-light mt-3 me-2" onclick="prevStep()"> &lt; 이전
                            </button>
                            <button type="button" class="btn btn-light mt-3" onclick="nextStep()"> > 다음 </button>
                        </div>
                    </div>

                    <!-- Step 5-->
                <div class="form-step" id="step5" style="display:none;">
                    <h5 class="text-white" th:text="${questionAnswerList[4].question}">질문 텍스트5</h5>

                    <label for="answer5" class="text-white d-block mb-1">답변을 입력하세요</label>
                    <textarea id="answer5"
                              class="form-control mb-4"
                              rows="6"
                              style="resize:none; min-height:200px;"
                              oninput="syncTextarea(this)"
                    ></textarea> <!-- ① 텍스트 입력 시 hidden 값 동기화 -->

                    <!-- hidden inputs -->
                    <input type="hidden" name="questions[4]"
                           th:value="${questionAnswerList[4].question}"/> <!-- ★ 인덱스 4 로 교정 -->
                    <input type="hidden" name="answerIds[4]"   value=""/>        <!-- null/공백 -->
                    <input type="hidden" name="answerTexts[4]" id="selectAnswerText4"/>

                    <div class="mt-4 text-center">
                        <button type="button" class="btn btn-light mt-3 me-2" onclick="prevStep()">&lt; 이전</button>
                        <button type="submit" class="btn btn-primary mt-3">제출</button>
                    </div>
                </div>

            </form>
        </div>
        <!-- ③ 고정 footer(nav)  ------------------>
        <nav class="bg-dark border-top py-2">
            <div class="d-flex justify-content-around text-white">
                <button class="btn btn-dark d-flex flex-column align-items-center">
                    <i class="fas fa-home"></i><small>홈</small>
                </button>
                <button class="btn btn-dark d-flex flex-column align-items-center">
                    <i class="fas fa-book"></i><small>내 서재</small>
                </button>
                <button class="btn btn-dark d-flex flex-column align-items-center">
                    <i class="fas fa-search"></i><small>책 추천</small>
                </button>
                <button class="btn btn-dark d-flex flex-column align-items-center">
                    <i class="fas fa-comments"></i><small>게시판</small>
                </button>
                <button class="btn btn-dark d-flex flex-column align-items-center">
                    <i class="fas fa-user"></i><small>내 정보</small>
                </button>
            </div>
        </nav>
    </div>
</section>

<script>
    let currentStep = 1;

    function nextStep() {
        document.getElementById(`step${currentStep}`).style.display = 'none';
        currentStep++;
        document.getElementById(`step${currentStep}`).style.display = 'block';
    }

    function prevStep() {
        document.getElementById(`step${currentStep}`).style.display = 'none';
        currentStep--;
        document.getElementById(`step${currentStep}`).style.display = 'block';
    }

    /* index: 0,1,2,3 (step1~4) */
    function toggleSelection(button, index) {

        /* ① 같은 step 안의 다른 버튼 비활성화 */
        const buttonGroupId = `step${index + 1}-answer-buttons`;
        document
            .querySelectorAll(`#${buttonGroupId} .active`)
            .forEach(btn => btn.classList.remove('active'));

        button.classList.add('active');

        /* ② data-id, text 추출 */
        const idValue   = button.dataset.id;      // answerIds 배열 값
        const textValue = button.innerText.trim(); // answerTexts 배열 값

        /* ③ hidden input 주입 */
        document.getElementById(`selectAnswerId${index}`).value   = idValue;
        document.getElementById(`selectAnswerText${index}`).value = textValue;
    }

    const cardBody = document.querySelector('.card-body');
    let scrollTimer;

    cardBody.addEventListener('scroll', () => {
        cardBody.classList.add('scrolling');

        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => {
            cardBody.classList.remove('scrolling');
        }, 800);
    });

    function syncTextarea(textarea) {
        // textarea.id == "answer5" ⇒ index 4
        document.getElementById("selectAnswerText4").value = textarea.value.trim();
    }
</script>
</body>

</html>