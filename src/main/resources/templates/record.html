<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>내 서재</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo&family=Noto+Serif+KR&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Dongle', sans-serif;
        }

        .gradient-custom {
            background: linear-gradient(to right, rgba(106, 17, 203, 1), rgba(37, 117, 252, 1));
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-main-container {
            border-radius: 1rem;
            width: 375px;
            height: 650px;
            background-color: #343a40;
            display: flex;
            flex-direction: column;
            margin: auto;
        }

        .card-header-custom {
            color: white;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, .125);
        }

        .card-header-custom h4 {
            font-family: 'Nanum Myeongjo', serif;
            margin-bottom: 0;
        }

        .card-body-scrollable {
            overflow-y: auto;
            flex-grow: 1;
            padding: 1rem;
            color: white;
        }

        .card-body-scrollable::-webkit-scrollbar {
            width: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card-body-scrollable::-webkit-scrollbar-track {
            background: transparent;
        }

        .card-body-scrollable::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .card-body-scrollable:hover::-webkit-scrollbar,
        .card-body-scrollable.scrolling::-webkit-scrollbar {
            opacity: 1;
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }

        .book-item {
            cursor: pointer;
            text-align: center;
            background-color: #fffff0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .book-item:hover {
            transform: scale(1.05);
        }

        .book-item img {
            max-width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .book-item p {
            font-size: 0.85rem;
            color: #333;
            margin-bottom: 0;
            font-family: 'Nanum Myeongjo', serif;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
        }

        /* --- 모달 스타일 --- */
        .modal-content-custom {
            background-color: #fffff0;
            color: #333;
            font-family: 'Nanum Myeongjo', serif;
            border-radius: 0.5rem;
        }

        .modal-header-custom {
            border-bottom: 1px solid #ddd;
            padding: 0.75rem 1rem;
        }

        .modal-header-custom .modal-title {
            font-size: 1.25rem;
        }

        .modal-book-cover {
            max-width: 120px;
            /* 책 정보 모달 내 표지 크기 조정 */
            height: auto;
            margin: 0 auto 1rem auto;
            border-radius: 0.25rem;
            display: block;
        }

        .modal-body-custom {
            padding: 1rem 1.5rem;
        }

        .modal-body-custom h5 {
            font-size: 1.15rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .modal-body-custom .text-muted {
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .modal-body-custom .book-description {
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 100px;
            /* 설명 영역 높이 조정 */
            overflow-y: auto;
            text-align: left;
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            /* 독서 기록과의 간격 */
        }

        /* 독서 기록 관련 스타일 */
        .reading-logs-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .reading-logs-container h6 {
            font-weight: bold;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .log-entry {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
        }

        .log-entry .log-date {
            font-weight: bold;
            color: #555;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .log-entry .log-text {
            margin-bottom: 0.5rem;
            line-height: 1.5;
            white-space: pre-wrap;
            /* 줄바꿈 및 공백 유지 */
        }

        .log-entry .log-image {
            max-width: 100%;
            max-height: 150px;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
        }

        .no-logs {
            color: #777;
            font-style: italic;
            font-size: 0.85rem;
        }

        /* 새 기록 추가 모달 스타일 */
        #addLogModal .form-group label {
            font-size: 0.9rem;
        }

        #logImagePreview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 0.25rem;
            border: 1px solid #ddd;
            padding: 5px;
            display: none;
            /* 처음엔 숨김 */
        }


        .footer-nav {
            background-color: #343a40;
            border-top: 1px solid rgba(255, 255, 255, .125);
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
        }

        .footer-nav .btn-dark {
            color: white;
            flex: 1;
        }

        .footer-nav .btn-dark.active {
            color: #ffc107;
        }

        .footer-nav .btn-dark i {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .log-text {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            /* 원하는 줄 수 */
            -webkit-box-orient: vertical;
            word-break: break-word;
            line-height: 1.4;
            /* 필요에 따라 조절 */
        }

        .log-text.full-text {
            display: block;
            -webkit-line-clamp: none;
        }
    </style>
</head>

<body class="gradient-custom">
    <section class="d-flex justify-content-center align-items-center">
        <div class="card-main-container">

            <div class="card-header-custom">
                <h4><i class="fas fa-book"></i> 내 서재</h4>
            </div>

            <div class="card-body-scrollable flex-grow-1" id="cardBodyScrollable">
                <div class="book-grid" id="myLibraryBookGrid">
                </div>
            </div>

            <nav class="footer-nav">
                <div class="d-flex justify-content-around text-white">
                    <button class="btn btn-dark d-flex flex-column align-items-center"
                        onclick="location.href='home.html'">
                        <i class="fas fa-home"></i><small>홈</small>
                    </button>
                    <button class="btn btn-dark d-flex flex-column align-items-center active">
                        <i class="fas fa-book"></i><small>내 서재</small>
                    </button>
                    <button class="btn btn-dark d-flex flex-column align-items-center"
                        onclick="location.href='book-recommendation.html'">
                        <i class="fas fa-search"></i><small>책 추천</small>
                    </button>
                    <button class="btn btn-dark d-flex flex-column align-items-center"
                        onclick="alert('게시판 페이지로 이동합니다.');">
                        <i class="fas fa-comments"></i><small>게시판</small>
                    </button>
                    <button class="btn btn-dark d-flex flex-column align-items-center"
                        onclick="location.href='mypage.html'">
                        <i class="fas fa-user"></i><small>내 정보</small>
                    </button>
                </div>
            </nav>
        </div>
    </section>

    <div class="modal fade" id="bookInfoModal" tabindex="-1" aria-labelledby="bookInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content modal-content-custom">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title" id="bookInfoModalLabel">책 정보</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body modal-body-custom">
                    <div class="text-center">
                        <img src="" id="modalBookCover" class="img-fluid modal-book-cover" alt="Book Cover">
                        <h5 id="modalBookTitle"></h5>
                        <p id="modalBookAuthor" class="text-muted"></p>
                    </div>
                    <div id="modalBookDescription" class="book-description"></div>

                    <div class="reading-logs-container">
                        <h6><i class="fas fa-feather-alt"></i> 독서 기록</h6>
                        <div id="modalBookLogsContainer">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success mr-auto" id="openAddLogModalBtn"><i
                            class="fas fa-plus"></i> 새 기록 추가</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addLogModal" tabindex="-1" aria-labelledby="addLogModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-content-custom">
                <form id="addLogForm">
                    <div class="modal-header modal-header-custom">
                        <h5 class="modal-title" id="addLogModalLabel">새 독서 기록 추가</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="currentBookIdForLog">
                        <div class="form-group">
                            <label for="logText">기록 내용</label>
                            <textarea class="form-control" id="logText" rows="5" required
                                style="font-size:0.9rem;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="logImage">사진 첨부 (선택 사항)</label>
                            <input type="file" class="form-control-file" id="logImage" accept="image/*">
                            <img id="logImagePreview" src="#" alt="이미지 미리보기" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">기록 저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"></script>

    <script>
        const cardBody = document.getElementById('cardBodyScrollable');
        let scrollTimer;

        if (cardBody) {
            cardBody.addEventListener('scroll', () => {
                cardBody.classList.add('scrolling');
                clearTimeout(scrollTimer);
                scrollTimer = setTimeout(() => {
                    cardBody.classList.remove('scrolling');
                }, 800);
            });
        }

        // 책 데이터 예시 (각 책에 id와 logs 배열 추가)
        // 책 데이터 예시 (각 책에 id와 logs 배열 추가)
        let myBooks = [ // let으로 변경하여 수정 가능하도록 함
            {
                id: "book1",
                title: "데미안",
                author: "헤르만 헤세",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F1467037",
                description: "에밀 싱클레어라는 인물의 자기 발견과 성장에 대한 이야기입니다...",
                logs: [
                    { id: "log1-1", date: "2024-05-01", text: "1장 읽음. 알을 깨고 나오는 새의 비유가 인상적이다.", image: null },
                    { id: "log1-2", date: "2024-05-03", text: "데미안과의 만남. 그의 눈빛이 잊혀지지 않는다.", image: "https://via.placeholder.com/150/FFA07A/000000?Text=Log+Image+1" }
                ]
            },
            {
                id: "book2",
                title: "어린 왕자",
                author: "앙투안 드 생텍쥐페리",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F5197",
                description: "사하라 사막에 불시착한 조종사가 다른 행성에서 온 어린 왕자를 만나면서 벌어지는 이야기입니다...",
                logs: []
            },
            // ... (다른 책 데이터도 id와 logs: [] 추가) ...
            {
                id: "book3",
                title: "연금술사",
                author: "파울로 코엘료",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F1650064",
                description: "양치기 소년 산티아고가 자아의 신화를 찾아 떠나는 여정을 그린 소설입니다...",
                logs: []
            },
            {
                id: "book4",
                title: "1984",
                author: "조지 오웰",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F466835",
                description: "전체주의 사회의 암울한 미래를 그린 디스토피아 소설입니다...",
                logs: []
            },
            {
                id: "book5",
                title: "멋진 신세계",
                author: "올더스 헉슬리",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F10119",
                description: "과학기술이 고도로 발달하여 모든 것이 통제되는 미래 사회를 배경으로 합니다...",
                logs: []
            },
            {
                id: "book6",
                title: "이방인",
                author: "알베르 카뮈",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F1673629",
                description: "뫼르소라는 인물을 통해 부조리한 세상과 인간 존재의 의미를 탐구하는 소설입니다...",
                logs: []
            },
            {
                id: "book7",
                title: "사피엔스",
                author: "유발 하라리",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F2700054",
                description: "인지 혁명, 농업 혁명, 과학 혁명을 거치며 호모 사피엔스가 어떻게 지구의 지배자가 되었는지...",
                logs: []
            },
            {
                id: "book8",
                title: "코스모스",
                author: "칼 세이건",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F682409",
                description: "우주의 광대함과 그 속의 지구, 생명의 경이로움을 과학적 사실과 철학적 사색을 통해 전달하는 교양 과학서의 고전입니다.",
                logs: []
            },
            {
                id: "book9",
                title: "총, 균, 쇠",
                author: "재레드 다이아몬드",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F11100",
                description: "지난 13,000년간 인류 문명이 대륙별로 다르게 발전한 이유를 환경적 요인(총, 균, 쇠로 대표되는 기술, 병원균, 지리적 이점 등)을 통해 분석합니다.",
                logs: []
            },
            {
                id: "book10",
                title: "정의란 무엇인가",
                author: "마이클 샌델",
                cover: "https://search1.kakaocdn.net/thumb/R120x174.q85/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flbook%2Fimage%2F571269",
                description: "공리주의, 자유지상주의, 칸트, 아리스토텔레스 등의 철학적 관점을 통해 정의에 대한 다양한 질문을 던지고 토론을 유도하는 책입니다.",
                logs: []
            }
        ];

        function displayMyLibrary() {
            const container = document.getElementById('myLibraryBookGrid');
            container.innerHTML = ''; // Clear previous content

            myBooks.forEach(book => {
                const bookElement = document.createElement('div');
                bookElement.classList.add('book-item');
                bookElement.setAttribute('data-book-id', book.id);

                const img = document.createElement('img');
                img.src = book.cover;
                img.alt = book.title;

                const title = document.createElement('p');
                title.textContent = book.title;

                bookElement.appendChild(img);
                bookElement.appendChild(title);
                container.appendChild(bookElement);
            });
        }

        // Modal 관련 JavaScript
        const bookInfoModal = $('#bookInfoModal');
        const addLogModal = $('#addLogModal');
        const openAddLogModalBtn = document.getElementById('openAddLogModalBtn');
        let currentBookId = null;

        $('#myLibraryBookGrid').on('click', '.book-item', function () {
            currentBookId = $(this).data('book-id');
            displayBookInfo(currentBookId);
            bookInfoModal.modal('show');
        });

        openAddLogModalBtn.addEventListener('click', () => {
            $('#currentBookIdForLog').val(currentBookId); // hidden input 필드에 값 설정
            addLogModal.modal('show');
        });

        addLogModal.on('hidden.bs.modal', () => {
            $('#addLogForm')[0].reset();
            $('#logImagePreview').attr('src', '#').hide();
        });


        function displayBookInfo(bookId) {
            const modalTitle = document.getElementById('modalBookTitle');
            const modalAuthor = document.getElementById('modalBookAuthor');
            const modalBookCover = document.getElementById('modalBookCover');
            const modalBookDescription = document.getElementById('modalBookDescription');
            const logsContainer = document.getElementById('modalBookLogsContainer');
            const book = myBooks.find(b => b.id === bookId);

            if (book) {
                modalTitle.textContent = book.title;
                modalAuthor.textContent = `저자: ${book.author}`;
                modalBookCover.src = book.cover;
                modalBookDescription.textContent = book.description;
                displayBookLogs(book.id);
            } else {
                console.error('Book not found!');
            }
        }

        function displayBookLogs(bookId) {
            const logsContainer = document.getElementById('modalBookLogsContainer');
            const book = myBooks.find(b => b.id === bookId);
            logsContainer.innerHTML = ''; // 기존 로그 초기화

            if (book && book.logs && book.logs.length > 0) {
                // 최신순으로 정렬 (날짜 문자열 비교)
                const sortedLogs = book.logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedLogs.forEach(log => {
                    const logImageHTML = log.image ? `<img src="${log.image}" alt="독서 기록 이미지" class="log-image">` : '';
                    const logElementHTML = `
                    <div class="log-entry" data-log-id="${log.id}">
                        <p class="log-date">${new Date(log.date).toLocaleDateString('ko-KR')} (${new Date(log.date).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })})</p>
                        <p class="log-text limited-text">${log.text.replace(/\n/g, '<br>')}</p>
                        ${logImageHTML}
                    </div>
                `;
                    logsContainer.innerHTML += logElementHTML;
                });

                if (sortedLogs.length > 0) {
                    // 더보기 버튼은 필요하지 않습니다. CSS로 처리
                }
            } else {
                logsContainer.innerHTML = '<pclass="no-logs">아직 기록이 없습니다.</p>';
            }
        }

        // logImagePreview
        $('#logImage').on('change', function () {
            const reader = new FileReader();
            reader.onload = (e) => {
                $('#logImagePreview').attr('src', e.target.result).show();
            };
            if (this.files[0]) {
                reader.readAsDataURL(this.files[0]);
            } else {
                $('#logImagePreview').attr('src', '#').hide();
            }
        });

        // 새 독서 기록 저장
        $('#addLogForm').on('submit', function (event) {
            event.preventDefault();
            const bookId = $('#currentBookIdForLog').val();
            const logText = $('#logText').val();
            const imageFile = $('#logImage')[0].files[0];

            const book = myBooks.find(b => b.id === bookId);
            if (!book) {
                alert('오류: 책을 찾을 수 없습니다.');
                return;
            }

            const newLog = {
                id: 'log' + bookId + '-' + (book.logs.length + 1) + '-' + Date.now(), // 간단한 고유 ID 생성
                date: new Date().toISOString(), // 현재 시간을 ISO 문자열로 저장
                text: logText,
                image: null // 기본값 null
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    newLog.image = e.target.result; // 이미지 데이터 URL 저장
                    book.logs.push(newLog);
                    displayBookLogs(bookId); // 책 정보 모달의 로그 목록 새로고침
                    $('#addLogModal').modal('hide');
                }
                reader.readAsDataURL(imageFile);
            } else {
                book.logs.push(newLog);
                displayBookLogs(bookId); // 책 정보 모달의 로그 목록 새로고침
                $('#addLogModal').modal('hide');
            }
            $('#addLogForm')[0].reset();
            $('#logImagePreview').attr('src', '#').hide();
        });

        $(document).ready(function () {
            displayMyLibrary();
        });
    </script>
</body>

</html>